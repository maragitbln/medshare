<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pill Tracker</title>
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        background:#f6f6f6;
        margin:0;
        padding:20px;
        max-width:600px;
        margin:auto;
    }
    h2 { margin-top:30px; }
    #loginBox {
        margin-top:80px;
        padding:20px;
        background:white;
        border-radius:12px;
        box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    #app { display:none; }

    button {
        width:100%;
        padding:16px;
        font-size:18px;
        border:none;
        border-radius:12px;
        background:#007aff;
        color:white;
        margin:10px 0;
    }
    button:disabled { background:#ccc; }

    .dayRow {
        display:flex;
        align-items:center;
        margin:8px 0;
    }
    .circles { margin-left:auto; display:flex; gap:8px; }
    .circle {
        width:22px; height:22px;
        border-radius:50%;
        border:2px solid #555;
    }
    .half { background:linear-gradient(to right, #555 50%, transparent 50%); }
    .full { background:#555; }
</style>
</head>

<body>

<!-- ---------------- SECRET LOGIN --------------- -->
<div id="loginBox">
    <h2>Enter PIN</h2>
    <input id="pinInput" type="password" placeholder="PIN" style="padding:12px; width:100%; font-size:18px;">
    <button onclick="checkPin()">Unlock</button>
    <p id="pinError" style="color:red; display:none;">Incorrect PIN</p>
</div>

<!-- ---------------- MAIN APP ------------------- -->
<div id="app">
    <h1>Pill Tracker</h1>

    <div id="status"></div>

    <button id="amBtn" onclick="logDose('06:30')">Log 06:30</button>
    <button id="pmBtn" onclick="logDose('17:30')">Log 17:30</button>

    <h2>Past 7 Days</h2>
    <div id="history"></div>

    <h2>Admin</h2>
    <button style="background:#b00020" onclick="clearAll()">Clear All Data</button>
</div>

<!-- ------------- FIREBASE + APP LOGIC ---------------- -->
<script type="module">

// ---------- LOCK SCREEN ----------
const SECRET_PIN = "1234"; // ← SET YOUR PIN HERE

function checkPin() {
    if (pinInput.value === SECRET_PIN) {
        loginBox.style.display = "none";
        app.style.display = "block";
        initApp();  // start Firebase + UI
    } else {
        pinError.style.display = "block";
    }
}

// ============ APP STARTUP AFTER UNLOCK ============
async function initApp() {

    /* ------------------ FIREBASE SDK LOAD ------------------ */
    const { initializeApp } =
        await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");

    const { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, query } =
        await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

    /* ------------------ REPLACE WITH YOUR CONFIG ------------------ */
    const firebaseConfig = {
      apiKey: "AIzaSyB09h7xfQXCCXu_TjZkG7Ro59HFzQtrW8c",
      authDomain: "medtrack-9b220.firebaseapp.com",
      projectId: "medtrack-9b220",
      storageBucket: "medtrack-9b220.firebasestorage.app",
      messagingSenderId: "419299696230",
      appId: "1:419299696230:web:509ed433ac9a391b4797a7"
    };
    /* -------------------------------------------------------------- */

    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);

    const doseBtnAM = document.getElementById("amBtn");
    const doseBtnPM = document.getElementById("pmBtn");
    const statusDiv = document.getElementById("status");
    const historyDiv = document.getElementById("history");

    // ---------- UTILITIES ----------
    function todayKey(time) {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${day}_${time}`;
    }

    // ---------- LOAD INITIAL BUTTON STATE ----------
    async function updateButtons() {
        await checkButton("06:30", doseBtnAM);
        await checkButton("17:30", doseBtnPM);
    }

    async function checkButton(time, btn) {
        const key = todayKey(time);
        const ref = doc(db, "pillLog", key);
        const snap = await getDoc(ref);
        btn.disabled = snap.exists();
        btn.innerText = snap.exists() ?
            `${time} ✔ Logged` :
            `Log ${time}`;
    }

    // ---------- LOGGING ----------
    async function logDose(time) {
        const key = todayKey(time);
        const ref = doc(db, "pillLog", key);

        const snap = await getDoc(ref);
        if (snap.exists()) {
            statusDiv.innerHTML = "Already logged.";
            return;
        }
        await setDoc(ref, { timestamp: new Date().toISOString() });

        statusDiv.innerHTML = "Saved!";
        updateButtons();
        loadHistory();
    }

    // ---------- LOAD LAST 7 DAYS ----------
    async function loadHistory() {
        historyDiv.innerHTML = "";

        const now = new Date();
        const items = [];

        for (let i=0;i<7;i++) {
            const d = new Date(now);
            d.setDate(now.getDate() - i);

            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,"0");
            const day = String(d.getDate()).padStart(2,"0");
            const dateKey = `${y}-${m}-${day}`;

            const amRef = doc(db, "pillLog", `${dateKey}_06:30`);
            const pmRef = doc(db, "pillLog", `${dateKey}_17:30`);

            const am = (await getDoc(amRef)).exists();
            const pm = (await getDoc(pmRef)).exists();

            items.push({ date: dateKey, am, pm });
        }

        items.forEach(item => {
            const row = document.createElement("div");
            row.className = "dayRow";
            row.innerHTML = `<strong>${item.date}</strong>`;

            const circles = document.createElement("div");
            circles.className = "circles";

            // AM circle
            const c1 = document.createElement("div");
            c1.className = "circle " + (item.am ? "half" : "");
            circles.appendChild(c1);

            // PM circle
            const c2 = document.createElement("div");
            c2.className = "circle " + (item.pm ? "half" : "");
            circles.appendChild(c2);

            // If both logged → merge into one full circle instead
            if (item.am && item.pm) {
                c1.className = "circle full";
                c2.style.display="none";
            }

            row.appendChild(circles);
            historyDiv.appendChild(row);
        });
    }

    // ---------- CLEAR ALL DATA ----------
    async function clearAll() {
        if (!confirm("Clear ALL data?")) return;
        const col = collection(db, "pillLog");
        const qs = await getDocs(col);
        for (const d of qs.docs) {
            await deleteDoc(d.ref);
        }
        updateButtons();
        loadHistory();
        statusDiv.innerHTML = "All data cleared.";
    }

    // Start
    updateButtons();
    loadHistory();
}
</script>
</body>
</html>
