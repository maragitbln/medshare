<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>MedShare</title>

<!-- iOS Home Screen Icon -->
<link rel="apple-touch-icon" href="icon.png">

<style>
    body {
        margin: 0;
        background: #0b0e11;
        color: #fff;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        padding: 20px;
    }
    h1 {
        font-size: 28px;
        margin-bottom: 10px;
    }
    .hidden { display: none; }
    .login-box, .main {
        max-width: 420px;
        margin: auto;
    }
    input, button, select {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: none;
        margin-top: 10px;
        font-size: 18px;
    }
    button {
        background: #1f6feb;
        color: white;
        font-weight: 600;
    }
    .day {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #161b22;
        padding: 14px;
        border-radius: 12px;
        margin-top: 10px;
    }
    .circle {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        border: 2px solid #888;
        background: transparent;
        position: relative;
        overflow: hidden;
    }
    .half::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 50%;
        background: #1f6feb;
    }
    .full {
        background: #1f6feb;
        border-color: #1f6feb;
    }

    .section-title {
        font-size: 20px;
        margin-top: 25px;
        margin-bottom: 10px;
        opacity: 0.85;
    }

    .admin-box {
        background: #111418;
        padding: 15px;
        border-radius: 12px;
        margin-top: 25px;
    }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js"></script>

</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login" class="login-box">
    <h1>MedShare</h1>
    <p>Enter PIN</p>
    <input id="pinInput" type="password">
    <button onclick="login()">Unlock</button>
</div>

<!-- MAIN APP -->
<div id="app" class="main hidden">
    <h1>MedShare</h1>

    <div class="section-title">This Week</div>
    <div id="week"></div>

    <div class="section-title">Add Entry</div>
    <div class="admin-box">
        <select id="who">
            <option>Bart</option>
        </select>

        <input id="med" placeholder="Medicine (e.g. Aspirin)" value="Aspirin" />

        <button onclick="giveMed()">Mark as Given</button>
    </div>

    <div class="section-title">Admin</div>
    <div class="admin-box">
        <button onclick="clearData()">Clear All Data</button>
    </div>
</div>

<script>
// ------------------------
// FIREBASE INIT
// ------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyB09h7xfQXCCXu_TjZkG7Ro59HFzQtrW8c",
      authDomain: "medtrack-9b220.firebaseapp.com",
      projectId: "medtrack-9b220",
      storageBucket: "medtrack-9b220.firebasestorage.app",
      messagingSenderId: "419299696230",
      appId: "1:419299696230:web:509ed433ac9a391b4797a7"
    };

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ------------------------
// PIN + AUTO LOGIN
// ------------------------
const CORRECT_PIN = "12psab96";

function autoLoginFromURL() {
    const params = new URLSearchParams(window.location.search);
    if (params.get("pin") === CORRECT_PIN) {
        localStorage.setItem("medshareLoggedIn", "1");
        showApp();
    }
}

function login() {
    const entered = document.getElementById("pinInput").value;
    if (entered === CORRECT_PIN) {
        localStorage.setItem("medshareLoggedIn", "1");
        showApp();
    } else {
        alert("Wrong PIN");
    }
}

function showApp() {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    loadWeek();
}

(function() {
    if (localStorage.getItem("medshareLoggedIn") === "1") {
        showApp();
    } else {
        autoLoginFromURL();
    }
})();

// ------------------------
// DATE HELPERS
// ------------------------
function todayKey() {
    const d = new Date();
    return d.toISOString().slice(0,10);
}

// ------------------------
// UI RENDERING
// ------------------------
async function loadWeek() {
    const weekDiv = document.getElementById("week");
    weekDiv.innerHTML = "";

    const snap = await db.collection("days").get();
    const data = {};
    snap.forEach(doc => data[doc.id] = doc.data());

    for (let i=6; i>=0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const key = d.toISOString().slice(0,10);
        const weekday = d.toLocaleDateString("en-US", { weekday: "short" });

        let state = data[key]?.count || 0;

        let className = "";
        if (state === 1) className = "half";
        if (state >= 2) className = "full";

        weekDiv.innerHTML += `
            <div class="day">
                <div>${weekday} â€” ${key}</div>
                <div class="circle ${className}"></div>
            </div>
        `;
    }
}

// ------------------------
// ADD MEDICATION ENTRY
// ------------------------
async function giveMed() {
    const key = todayKey();
    const ref = db.collection("days").doc(key);

    await db.runTransaction(async (tx) => {
        const doc = await tx.get(ref);
        const count = doc.exists ? (doc.data().count || 0) : 0;
        tx.set(ref, { count: Math.min(count + 1, 2) });
    });

    loadWeek();
}

// ------------------------
// CLEAR ALL DATA
// ------------------------
async function clearData() {
    if (!confirm("Delete ALL entries?")) return;

    const snap = await db.collection("days").get();
    const batch = db.batch();
    snap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    loadWeek();
}

</script>
</body>
</html>
