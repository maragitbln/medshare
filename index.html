<!doctype html>
const left = document.createElement('div');
left.innerHTML = `<div class='time'>${t}</div><div style='font-size:13px;color:var(--muted)'>Elvanse 30mg</div>`;
const right = document.createElement('div');
if (takenMap[t]){
right.innerHTML = `<span class='taken'>Taken by ${takenMap[t].user} at ${new Date(takenMap[t].ts).toLocaleTimeString()}</span>`;
} else {
const btn = document.createElement('button');
btn.className='btn';
btn.textContent='Mark taken';
btn.onclick = ()=>{ quickLog('Manual', 'Elvanse', t); }
right.appendChild(btn);
}
div.appendChild(left);div.appendChild(right);
scheduleEl.appendChild(div);
})
}


async function checkUrlForAutoLog(){
const params = new URLSearchParams(location.search);
if (params.has('user') && params.has('med') && params.has('time')){
const user = params.get('user');
const med = params.get('med');
const time = params.get('time');
await quickLog(user, med, time);
history.replaceState({}, '', './');
alert(`${med} logged for ${user} at ${new Date().toLocaleTimeString()}`);
}
}


async function quickLog(user, med, scheduledTime){
try{
await addDoc(collection(db, 'events'), {
user,
med,
scheduledTime,
ts: serverTimestamp()
});
} catch(e){
console.error('Error logging event', e);
alert('Failed to log event. Check console.');
}
}


document.getElementById('markBtn').addEventListener('click', ()=>{
const user = document.getElementById('userName').value || 'Manual';
const med = document.getElementById('medName').value || 'Elvanse';
const time = document.getElementById('scheduledTime').value || new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
quickLog(user, med, time);
});


document.getElementById('refreshBtn').addEventListener('click', ()=>renderSchedule());


const q = query(collection(db, 'events'), orderBy('ts','desc'));
onSnapshot(q, snapshot=>{
liveStatus.innerHTML = '';
const takenMap = {};
logEl.innerHTML = '';


snapshot.forEach(docSnap=>{
const data = docSnap.data();
const ts = data.ts && data.ts.toDate ? data.ts.toDate() : new Date();
const key = data.scheduledTime || 'free';
if (!takenMap[key]) takenMap[key] = { user: data.user, ts: ts };


const item = document.createElement('div');
item.className = 'log-item';
item.textContent = `${ts.toLocaleString()} — ${data.user} logged ${data.med} (scheduled ${data.scheduledTime || 'n/a'})`;
logEl.appendChild(item);
});


if (Object.keys(takenMap).length === 0){
liveStatus.innerHTML = `<div style='color:var(--muted)'>No doses logged yet</div>`;
} else {
const frag = document.createDocumentFragment();
for (const [time, info] of Object.entries(takenMap)){
const el = document.createElement('div');
el.innerHTML = `<span class='status-dot status-ok'></span><strong>${time}</strong> — ${info.user} at ${new Date(info.ts).toLocaleTimeString()}`;
frag.appendChild(el);
}
liveStatus.appendChild(frag);
}
renderSchedule(takenMap);
});


checkUrlForAutoLog();
renderSchedule();


if ('serviceWorker' in navigator){
navigator.serviceWorker.register('sw.js').catch(()=>{});
}
</script>
</body>
</html>
