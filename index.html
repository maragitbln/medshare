<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MedShare — Given Tracker</title>

<!-- Use a PNG named 'icon.png' placed in the same folder as index.html -->
<link rel="apple-touch-icon" href="icon.png">

<meta name="theme-color" content="#071126">

<style>
  :root{
    --bg:#071126;
    --card:#0b1220;
    --muted:#9aa6b2;
    --accent:#6ee7b7;
    --danger:#f87171;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial;color:#e6eef6;background:linear-gradient(180deg,#071126 0%,#0b1220 100%);}
  .wrap{max-width:820px;margin:12px auto;padding:14px}
  header{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;background:linear-gradient(135deg,#22c1c3,#6ee7b7);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#04202a}
  h1{margin:0;font-size:20px}
  p.lead{margin:4px 0 14px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
  .small{font-size:13px;color:var(--muted)}
  .row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--glass)}
  .time{font-weight:700}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--accent);cursor:pointer}
  .btn-primary{background:linear-gradient(90deg,#22c1c3,#6ee7b7);color:#04202a;border:none;padding:10px 16px;border-radius:12px;cursor:pointer}
  .danger{background:var(--danger);color:#111;border:none;padding:10px 12px;border-radius:10px}
  input,select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .history{margin-top:12px}
  .day{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}
  .circles{display:flex;gap:8px;align-items:center}
  .circle{width:22px;height:22px;border-radius:50%;border:2px solid rgba(255,255,255,0.06);display:inline-block}
  .circle.empty{background:transparent}
  .circle.half{background:linear-gradient(90deg,#6ee7b7 50%, transparent 50%)}
  .circle.full{background:#6ee7b7;border-color:#6ee7b7}
  footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
  .top-actions{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">MS</div>
      <div>
        <h1>MedShare</h1>
        <p class="lead">Shared medication tracker — quick logging from Shortcuts</p>
      </div>
    </header>

    <!-- PIN prompt (or nothing if cached unlocked) -->
    <div id="pinCard" class="card" style="margin-top:12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-weight:700">Unlock MedShare</div>
          <div class="small muted">Enter PIN to see dashboard. (Home-screen opens keep you unlocked.)</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="pinInput" type="password" placeholder="PIN" style="width:120px">
          <button id="pinBtn" class="btn-primary">Unlock</button>
        </div>
      </div>
      <div id="pinMsg" class="small muted" style="margin-top:8px;"></div>
    </div>

    <div id="appUI" class="hidden">
      <div class="grid">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">Today's schedule</div>
              <div class="small muted">Standard times: 06:30 and 17:30</div>
            </div>
            <div style="text-align:right">
              <div class="small muted">Logged by:</div>
              <div id="lastGiven" class="small muted">—</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <div class="time">06:30</div>
              <div class="small muted">Medication</div>
            </div>
            <div id="btnSlotAM">
              <button class="btn" id="amManualBtn">Mark given</button>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="time">17:30</div>
              <div class="small muted">Medication</div>
            </div>
            <div id="btnSlotPM">
              <button class="btn" id="pmManualBtn">Mark given</button>
            </div>
          </div>

          <div style="margin-top:10px" class="small muted">Manual logs also update the shared record.</div>

          <div class="history">
            <h3 style="margin:12px 0 6px 0">Past 7 days</h3>
            <div id="weekHistory"></div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;flex-direction:column;gap:10px">
            <div>
              <div style="font-weight:700">Manual quick log</div>
              <div class="small muted">Use when you want to log custom user or med</div>
            </div>

            <input id="manualUser" placeholder="Name (e.g. Ben)">
            <input id="manualMed" placeholder="Medication (e.g. Elvanse)" style="margin-top:8px">
            <select id="manualTime" style="margin-top:8px">
              <option value="06:30">06:30</option>
              <option value="17:30">17:30</option>
            </select>

            <button id="manualLogBtn" class="btn-primary" style="margin-top:8px">Log manual</button>

            <hr style="opacity:0.06;margin:12px 0">

            <div>
              <div style="font-weight:700">Danger zone</div>
              <div class="small muted">Clears the entire dataset (use with caution)</div>
            </div>
            <button id="clearBtn" class="danger">Clear all logs</button>

            <div style="margin-top:12px">
              <div class="small muted">Add to home screen for faster access. Shortcut logging URL example below.</div>
            </div>

            <div style="margin-top:8px" class="small muted">
              <div>Shortcut logging URL (embed PIN):</div>
              <code id="shortcutExample" style="font-size:12px;display:block;word-break:break-all;margin-top:6px"></code>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="small muted">Tip: Add to Home Screen to keep you unlocked with local cache. Shortcut calls include PIN to auto-log.</div>
      </footer>
    </div>
  </div>

<script type="module">
/* -------------------------
  IMPORTANT: update these
----------------------------*/

/* 1) Paste Firebase config from Firebase console (Web app) here */
    const firebaseConfig = {
      apiKey: "AIzaSyB09h7xfQXCCXu_TjZkG7Ro59HFzQtrW8c",
      authDomain: "medtrack-9b220.firebaseapp.com",
      projectId: "medtrack-9b220",
      storageBucket: "medtrack-9b220.firebasestorage.app",
      messagingSenderId: "419299696230",
      appId: "1:419299696230:web:509ed433ac9a391b4797a7"
    };

/* 2) Set your PIN (used for dashboard unlock) */
const SECRET_PIN = "12psab96";

/* 3) How long to keep "unlocked" in ms (e.g., 7 days) */
const UNLOCK_DURATION = 7 * 24 * 3600 * 1000;

/* 4) Shortcut URL base (your GitHub Pages site) - update after you publish */
const SITE_BASE = location.origin + location.pathname.replace(/\/[^/]*$/, '/'); // auto base, usually works

/* -------------------------
  End of user-editable options
----------------------------*/

/* Imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, setDoc, deleteDoc, getDocs, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

/* Initialize Firebase app (we do it immediately so Firestore functions are available).
   But we will delay "app UI" until PIN check completes.
*/
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* Utility helpers */
function qs(param) { return new URLSearchParams(location.search).get(param); }
function nowDateKey() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function todayDocId(time) { return `${nowDateKey()}_${time}`; }
function makeShortcutUrl(params) {
  const base = SITE_BASE + (SITE_BASE.endsWith('/') ? '' : '/');
  const u = new URL(base + (location.pathname.split('/').pop() || 'index.html'));
  Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
  return u.toString();
}

/* Elements */
const pinCard = document.getElementById('pinCard');
const pinInput = document.getElementById('pinInput');
const pinBtn = document.getElementById('pinBtn');
const pinMsg = document.getElementById('pinMsg');

const appUI = document.getElementById('appUI');
const amManualBtn = document.getElementById('amManualBtn');
const pmManualBtn = document.getElementById('pmManualBtn');
const lastGiven = document.getElementById('lastGiven');

const weekHistory = document.getElementById('weekHistory');
const manualUser = document.getElementById('manualUser');
const manualMed = document.getElementById('manualMed');
const manualTime = document.getElementById('manualTime');
const manualLogBtn = document.getElementById('manualLogBtn');
const clearBtn = document.getElementById('clearBtn');
const shortcutExample = document.getElementById('shortcutExample');

/* Shortcut logging flow:
   Option A requested two separate URLs:
   - Dashboard: index.html (the Home Screen shortcut)
   - Shortcut logging URL: index.html?action=log&pin=...&time=06:30&user=Ben&med=Elvanse

   We'll implement the action=log behaviour here so the Shortcut link calls the same file but with query params.
*/

/* Check if loaded with action=log */
(async function handleAutoLog() {
  const action = qs('action');
  if (action !== 'log') return;

  const pin = qs('pin') || '';
  const time = qs('time') || '';
  const user = qs('user') || 'Shortcut';
  const med = qs('med') || 'Medication';

  // validate minimal
  if (pin !== SECRET_PIN) {
    document.body.innerHTML = `<div style="padding:30px;color:#fff;background:#111;height:100vh;display:flex;align-items:center;justify-content:center"><div style="max-width:600px"><h2 style="color:#f88">Auth failed</h2><p style="color:#ddd">Invalid pin in shortcut URL. Logging aborted.</p></div></div>`;
    return;
  }
  if (!time) {
    document.body.innerHTML = `<div style="padding:30px;color:#fff;background:#111;height:100vh;display:flex;align-items:center;justify-content:center"><div style="max-width:600px"><h2 style="color:#f88">Missing time</h2></div></div>`;
    return;
  }

  // check existing
  const id = `${nowDateKey()}_${time}`;
  const ref = doc(db, 'pillLog', id);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    const d = snap.data();
    document.body.innerHTML = `<div style="padding:30px;color:#fff;background:#071126;height:100vh;display:flex;align-items:center;justify-content:center"><div style="max-width:600px;text-align:center"><h2 style="color:#6ee7b7">Already given</h2><p style="color:#cfe">${d.user || d.by || 'someone'} gave ${d.med || med} at ${new Date(d.timestamp).toLocaleTimeString()}</p></div></div>`;
    return;
  }

  // create record
  await setDoc(ref, { user, med, timestamp: new Date().toISOString() });

  document.body.innerHTML = `<div style="padding:30px;color:#071126;background:#6ee7b7;height:100vh;display:flex;align-items:center;justify-content:center"><div style="max-width:600px;text-align:center"><h2 style="color:#022">Logged ✓</h2><p style="color:#022">Recorded ${med} for ${user} at ${time}.</p></div></div>`;
  return;
})();

/* ---------- PIN unlocking & caching ---------- */
function isUnlocked() {
  try {
    const data = JSON.parse(localStorage.getItem('medshare_unlocked') || 'null');
    if (!data) return false;
    return Date.now() < data.expiry;
  } catch (e) { return false; }
}
function setUnlocked() {
  localStorage.setItem('medshare_unlocked', JSON.stringify({ expiry: Date.now() + UNLOCK_DURATION }));
}
function clearUnlocked() { localStorage.removeItem('medshare_unlocked'); }

async function showAppIfUnlocked() {
  if (isUnlocked()) {
    pinCard.classList.add('hidden');
    appUI.classList.remove('hidden');
    await startAppUI();
  } else {
    pinCard.classList.remove('hidden');
    appUI.classList.add('hidden');
  }
}

/* PIN button */
pinBtn.addEventListener('click', async () => {
  pinMsg.textContent = '';
  if (pinInput.value === SECRET_PIN) {
    setUnlocked();
    pinCard.classList.add('hidden');
    appUI.classList.remove('hidden');
    await startAppUI();
  } else {
    pinMsg.textContent = 'Incorrect PIN';
    pinInput.value = '';
  }
});

/* Build Shortcut example URL */
function showShortcutExample() {
  const u = makeShortcutUrl({ action:'log', pin: SECRET_PIN, time: '06:30', user: 'Ben', med: 'Elvanse' });
  shortcutExample.textContent = u;
}

/* ---------- App UI logic (after unlock) ---------- */
let appStarted = false;
async function startAppUI() {
  if (appStarted) return;
  appStarted = true;

  // wire manual buttons
  amManualBtn.addEventListener('click', async () => {
    await manualLogQuick('06:30');
  });
  pmManualBtn.addEventListener('click', async () => {
    await manualLogQuick('17:30');
  });

  manualLogBtn.addEventListener('click', async () => {
    const user = manualUser.value.trim() || 'Manual';
    const med = manualMed.value.trim() || 'Medication';
    const time = manualTime.value;
    await logGiven(user, med, time);
  });

  clearBtn.addEventListener('click', async () => {
    if (!confirm('Delete ALL logs? This cannot be undone.')) return;
    const col = collection(db, 'pillLog');
    const docs = await getDocs(col);
    for (const d of docs.docs) await deleteDoc(doc(db, 'pillLog', d.id));
    await refreshUI();
  });

  showShortcutExample();
  await refreshUI();
}

/* helper: quick manual log using default name */
async function manualLogQuick(time) {
  const user = manualUser.value.trim() || 'Manual';
  const med = manualMed.value.trim() || 'Medication';
  await logGiven(user, med, time);
}

/* Main logging function used by both manual and shortcut (shortcut uses separate handler earlier) */
async function logGiven(user, med, time) {
  const id = `${nowDateKey()}_${time}`;
  const ref = doc(db, 'pillLog', id);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    alert('Already logged for that time today.');
    return;
  }
  await setDoc(ref, { user, med, timestamp: new Date().toISOString() });
  await refreshUI();
}

/* Render week history and status */
async function refreshUI() {
  // last given quick check
  const col = collection(db, 'pillLog');
  const allDocs = await getDocs(col); // small DB, ok for prototype
  let last = '—';
  allDocs.docs.forEach(d => {
    const data = d.data();
    if (!last || new Date(data.timestamp) > new Date(last.ts || 0)) {
      last = { ts: data.timestamp, user: data.user || '—', med: data.med || '—' };
    }
  });
  lastGiven.textContent = last === '—' ? '—' : `${last.user} • ${new Date(last.ts).toLocaleString()}`;

  // week overview
  weekHistory.innerHTML = '';
  const now = new Date();
  for (let i=0;i<7;i++){
    const d = new Date(now);
    d.setDate(now.getDate() - i);
    const dateKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const amId = `${dateKey}_06:30`;
    const pmId = `${dateKey}_17:30`;
    const amSnap = await getDoc(doc(db,'pillLog',amId));
    const pmSnap = await getDoc(doc(db,'pillLog',pmId));
    const am = amSnap.exists();
    const pm = pmSnap.exists();

    const row = document.createElement('div');
    row.className = 'day';
    row.innerHTML = `<div>${dateKey}</div>`;
    const circles = document.createElement('div');
    circles.className = 'circles';
    const c1 = document.createElement('div');
    const c2 = document.createElement('div');
    c1.className = 'circle ' + (am ? (pm ? 'full' : 'half') : 'empty');
    c2.className = 'circle ' + (pm ? (am ? 'hidden' : 'half') : 'empty');
    if (pm && am) { c2.style.display='none'; } // show single full circle when both logged
    circles.appendChild(c1);
    circles.appendChild(c2);
    row.appendChild(circles);
    weekHistory.appendChild(row);
  }

  // update buttons state for today
  const amSnapToday = await getDoc(doc(db,'pillLog', todayDocId('06:30')));
  const pmSnapToday = await getDoc(doc(db,'pillLog', todayDocId('17:30')));
  amManualBtn.disabled = amSnapToday.exists();
  amManualBtn.textContent = amSnapToday.exists() ? '06:30 ✓ Given' : 'Mark given';
  pmManualBtn.disabled = pmSnapToday.exists();
  pmManualBtn.textContent = pmSnapToday.exists() ? '17:30 ✓ Given' : 'Mark given';
}

/* On load */
(async function() {
  // If page was opened with action=log, handled earlier in handleAutoLog() IIFE.
  // Otherwise show UI or PIN prompt depending on cache
  if (!qs('action')) {
    await showAppIfUnlocked();
    showShortcutExample();
  }
})();
</script>
</body>
</html>
