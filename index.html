<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MedTrack</title>

<style>
/* ---- RESET ---- */
body {
  margin: 0;
  padding: 0;
  background: #f6f7f9;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
    "Helvetica Neue", Arial, sans-serif;
  color: #222;
}

/* ---- CONTAINER ---- */
#app {
  max-width: 500px;
  margin: 0 auto;
  padding: 20px;
  text-align: center;
}

/* ---- HEADER ---- */
h1 {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 10px;
}
.subtitle {
  font-size: 1.1rem;
  margin-bottom: 25px;
}

/* ---- GRID ---- */
.week-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  column-gap: 10px;
  margin-top: 20px;
}

/* ---- CIRCLES ---- */
.circle {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 3px solid #888;
  margin: 0 auto;
  position: relative;
  overflow: hidden;
}
.empty {
  background: transparent;
}
.half::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 50%;
  background: #4caf50;
}
.full {
  background: #4caf50;
}

/* ---- BUTTONS ---- */
.action-btn {
  margin-top: 25px;
  padding: 14px 20px;
  background: #007aff;
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 600;
}
.action-btn:active {
  background: #0055cc;
}

/* ---- LOGIN SCREEN ---- */
#lockScreen {
  display: none;
  padding: 40px;
}
#pinInput {
  font-size: 1.4rem;
  padding: 12px;
  width: 180px;
  margin: 20px auto;
  text-align: center;
  border-radius: 12px;
  border: 2px solid #ccc;
}
#unlockBtn {
  padding: 13px 22px;
  font-size: 1.2rem;
  background: #007aff;
  color: white;
  border: none;
  border-radius: 12px;
}
#unlockBtn:active {
  background: #0055cc;
}

/* ---- ICON ---- */
#appIcon {
  width: 110px;
  margin: 20px auto;
  display: block;
}
</style>
</head>

<body>

<div id="lockScreen">
  <h1>MedTrack</h1>
  <img id="appIcon" src="cap_icon.png" alt="icon" />
  <p>Enter secret:</p>
  <input id="pinInput" type="password" />
  <br />
  <button id="unlockBtn">Unlock</button>
</div>

<div id="app" style="display:none;">
  <h1>MedTrack</h1>
  <div class="subtitle" id="subtitleText"></div>

  <div class="week-grid" id="weekGrid"></div>

  <button class="action-btn" id="giveBtn">Mark Given</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js"></script>

<script>
/* -----------------------------------------------------
   CONFIG
----------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyB09h7xfQXCCXu_TjZkG7Ro59HFzQtrW8c",
  authDomain: "medtrack-9b220.firebaseapp.com",
  databaseURL: "https://medtrack-9b220-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "medtrack-9b220",
  storageBucket: "medtrack-9b220.firebasestorage.app",
  messagingSenderId: "419299696230",
  appId: "1:419299696230:web:509ed433ac9a391b4797a7"
};

const SECRET = "hf82ja.aig93we92";   // <-- CHANGE THIS
const CHILD_NAME = "Bart";
const MED_NAME = "LamBri";

/* -----------------------------------------------------
   INIT
----------------------------------------------------- */
const appFB = firebase.initializeApp(firebaseConfig);
const db = firebase.getDatabase(appFB);

const qs = new URLSearchParams(location.search);
const urlSecret = qs.get("secret");

/* Auto-login if secret provided in URL */
if (urlSecret === SECRET) {
  showApp();
} else {
  document.getElementById("lockScreen").style.display = "block";
}

/* Manual unlock */
document.getElementById("unlockBtn").onclick = () => {
  const entered = document.getElementById("pinInput").value.trim();
  if (entered === SECRET) {
    showApp();
  } else {
    alert("Wrong secret.");
  }
};

/* -----------------------------------------------------
   SHOW MAIN UI
----------------------------------------------------- */
function showApp() {
  document.getElementById("lockScreen").style.display = "none";
  document.getElementById("app").style.display = "block";
  loadWeek();
}

/* -----------------------------------------------------
   DATE HELPERS
----------------------------------------------------- */
function formatDate(d) {
  return d.toISOString().split("T")[0];
}

function getPast7Days() {
  const base = new Date();
  const out = [];
  for (let i = 6; i >= 0; i--) {
    let t = new Date(base);
    t.setDate(t.getDate() - i);
    out.push(formatDate(t));
  }
  return out;
}

/* -----------------------------------------------------
   LOAD WEEK DATA
----------------------------------------------------- */
async function loadWeek() {
  document.getElementById("subtitleText").textContent =
    `${CHILD_NAME} — ${MED_NAME}`;

  const week = getPast7Days();
  const grid = document.getElementById("weekGrid");
  grid.innerHTML = "";

  for (let day of week) {
    const ref = firebase.ref(db, "days/" + day);
    const snap = await firebase.get(ref);

    let state = "empty";
    if (snap.exists()) {
      const v = snap.val().value || 0;
      if (v === 1) state = "half";
      if (v === 2) state = "full";
    }

    const cell = document.createElement("div");
    cell.className = "circle " + state;
    grid.appendChild(cell);
  }
}

/* -----------------------------------------------------
   MARK TODAY AS GIVEN
----------------------------------------------------- */
document.getElementById("giveBtn").onclick = async () => {
  const today = formatDate(new Date());
  const ref = firebase.ref(db, "days/" + today);

  // Read existing
  const snap = await firebase.get(ref);
  let prev = 0;
  if (snap.exists()) {
    prev = snap.val().value || 0;
  }

  // Cycle empty → half → full
  let next = prev + 1;
  if (next > 2) next = 2;

  // Write with secret
  await firebase.set(ref, {
    value: next,
    secret: SECRET
  });

  loadWeek();
};
</script>
</body>
</html>
