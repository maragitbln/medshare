<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="MedShare">
  <link rel="apple-touch-icon" href="icon.png">
  <title>MedShare — Given Tracker</title>

  <style>
    :root{
      --bg:#071126; --card:#0b1220; --muted:#9aa6b2; --accent:#6ee7b7; --danger:#f87171; --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#e6eef6;background:linear-gradient(180deg,#071126 0%,#0b1220 100%);}
    .wrap{max-width:820px;margin:12px auto;padding:14px}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;background:linear-gradient(135deg,#22c1c3,#6ee7b7);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#04202a}
    h1{margin:0;font-size:20px}
    p.lead{margin:4px 0 14px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    .small{font-size:13px;color:var(--muted)}
    .row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--glass)}
    .time{font-weight:700}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--accent);cursor:pointer}
    .btn.active{background:linear-gradient(90deg,#22c1c3,#6ee7b7);color:#04202a;border:none}
    .btn-primary{background:linear-gradient(90deg,#22c1c3,#6ee7b7);color:#04202a;border:none;padding:10px 16px;border-radius:12px;cursor:pointer}
    .danger{background:var(--danger);color:#111;border:none;padding:10px 12px;border-radius:10px}
    input,select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .history{margin-top:12px}
    .day{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}
    .circles{display:flex;gap:8px;align-items:center}
    .circle{width:26px;height:26px;border-radius:50%;border:2px solid rgba(255,255,255,0.06);background:transparent;position:relative;overflow:hidden}
    .circle.half::before{content:'';position:absolute;left:0;top:50%;width:100%;height:50%;background:linear-gradient(90deg,#6ee7b7,#22c1c3)}
    .circle.full{background:linear-gradient(90deg,#22c1c3,#6ee7b7);border-color:transparent}
    .section-title{font-size:16px;margin-top:18px;margin-bottom:8px;color:var(--muted)}
    footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
    .muted{color:var(--muted)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">MS</div>
      <div>
        <h1>MedShare</h1>
        <p class="lead">Shared medication tracker — quick logging from Shortcuts</p>
      </div>
    </header>

    <!-- PIN prompt -->
    <div id="pinCard" class="card" style="margin-top:12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-weight:700">Unlock MedShare</div>
          <div class="small muted">Enter PIN to see dashboard. Add to Home Screen for cached unlock.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="pinInput" type="password" placeholder="PIN" style="width:120px" />
          <button id="pinBtn" class="btn-primary">Unlock</button>
        </div>
      </div>
      <div id="pinMsg" class="small muted" style="margin-top:8px;"></div>
    </div>

    <!-- Main UI -->
    <div id="appUI" class="hidden">
      <div class="grid">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">Today's schedule</div>
              <div class="small muted">Standard times: 06:30 and 17:30</div>
            </div>
            <div style="text-align:right">
              <div class="small muted">Last given</div>
              <div id="lastGiven" class="small muted">—</div>
            </div>
          </div>

          <div style="margin-top:12px" class="row">
            <div>
              <div class="time">06:30</div>
              <div class="small muted">LamBri</div>
            </div>
            <div id="btnSlotAM">
              <button class="btn" id="amManualBtn">Mark given</button>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="time">17:30</div>
              <div class="small muted">LamBri</div>
            </div>
            <div id="btnSlotPM">
              <button class="btn" id="pmManualBtn">Mark given</button>
            </div>
          </div>

          <div class="history">
            <div class="section-title">Past 7 days</div>
            <div id="weekHistory"></div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;flex-direction:column;gap:10px">
            <div>
              <div style="font-weight:700">Manual log</div>
              <div class="small muted">For logging a different user or medicine</div>
            </div>

            <input id="manualUser" placeholder="Name (e.g. Bart)" value="Bart">
            <input id="manualMed" placeholder="Medicine (e.g. LamBri)" value="LamBri" style="margin-top:8px">
            <select id="manualTime" style="margin-top:8px">
              <option value="06:30">06:30</option>
              <option value="17:30">17:30</option>
            </select>

            <button id="manualLogBtn" class="btn-primary" style="margin-top:8px">Log manual</button>

            <hr style="opacity:0.06;margin:12px 0">

            <div>
              <div style="font-weight:700">Danger zone</div>
              <div class="small muted">Resets all day counts (documents remain)</div>
            </div>
            <button id="clearBtn" class="danger">Clear all logs</button>

            <div style="margin-top:12px" class="small muted">
              <div>Shortcut URL (auto PIN):</div>
              <code id="shortcutExample" style="font-size:12px;display:block;word-break:break-all;margin-top:6px"></code>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="small muted">Tip: Add to Home Screen to stay unlocked.</div>
      </footer>
    </div>
  </div>

<script type="module">
/* ----------------------
   CONFIG
   ---------------------- */
const SECRET_PIN = "12psab92";
const WRITE_SECRET = "ads39akmd9823j";
const UNLOCK_DURATION_MS = 7 * 24 * 3600 * 1000;

const firebaseConfig = {
  apiKey: "AIzaSyB09h7xfQXCCXu_TjZkG7Ro59HFzQtrW8c",
  authDomain: "medtrack-9b220.firebaseapp.com",
  projectId: "medtrack-9b220",
  storageBucket: "medtrack-9b220.appspot.com",
  messagingSenderId: "419299696230",
  appId: "1:419299696230:web:509ed433ac9a391b4797a7"
};

/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore,
  collection,
  doc,
  getDoc,
  setDoc,
  getDocs,
  deleteField
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* Helpers */
const qs = k => new URLSearchParams(location.search).get(k);
const nowDateKey = (d = new Date()) =>
  `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

const todayDocRef = () => doc(db, "pillLog", nowDateKey());

/* DOM elements */
const pinCard = document.getElementById('pinCard');
const pinInput = document.getElementById('pinInput');
const pinBtn = document.getElementById('pinBtn');
const pinMsg = document.getElementById('pinMsg');
const appUI = document.getElementById('appUI');

const amManualBtn = document.getElementById('amManualBtn');
const pmManualBtn = document.getElementById('pmManualBtn');
const lastGiven = document.getElementById('lastGiven');
const weekHistory = document.getElementById('weekHistory');
const manualUser = document.getElementById('manualUser');
const manualMed = document.getElementById('manualMed');
const manualTime = document.getElementById('manualTime');
const manualLogBtn = document.getElementById('manualLogBtn');
const clearBtn = document.getElementById('clearBtn');
const shortcutExample = document.getElementById('shortcutExample');

/* Build URL for Shortcuts */
function makeShortcutUrl(params) {
  const u = new URL(location.origin + location.pathname);
  Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
  return u.toString();
}

/* Secure writer (never stores the secret) */
async function secureWrite(ref, data) {
  const payload = { ...data, writeSecret: WRITE_SECRET };

  // Write with secret included
  await setDoc(ref, payload, { merge: true });

  // Immediately remove writeSecret from stored document
  await setDoc(ref, { writeSecret: deleteField() }, { merge: true });
}

/* HANDLE AUTLOG (Shortcuts) */
async function handleAutoLog() {
  const action = qs('action');
  if (action !== 'log') return false;

  if (qs('pin') !== SECRET_PIN) {
    document.body.innerHTML =
      `<div style="padding:30px;color:#fff;"><h2 style="color:#f33">Auth failed</h2></div>`;
    return true;
  }

  const time = qs('time');
  const user = qs('user') || 'Bart';
  const med = qs('med') || 'LamBri';

  if (!time) return true;

  const ref = todayDocRef();
  const snap = await getDoc(ref);

  let amGiven = false, pmGiven = false;
  if (snap.exists()) {
    const d = snap.data();
    amGiven = !!d.amGiven;
    pmGiven = !!d.pmGiven;
  }

  if (time === "06:30") amGiven = true;
  else if (time === "17:30") pmGiven = true;

  await secureWrite(ref, {
    amGiven, pmGiven,
    count: (amGiven?1:0)+(pmGiven?1:0),
    lastUser: user,
    lastMed: med,
    lastTs: new Date().toISOString()
  });

  document.body.innerHTML =
    `<div style="padding:30px;color:#071126;background:#6ee7b7;height:100vh;display:flex;align-items:center;justify-content:center"><div style="max-width:600px;text-align:center"><h2 style="color:#022">Logged ✓</h2><p style="color:#022">${med} for ${user} at ${time} recorded.</p></div></div>`;

  return true;
}

/* PIN cache */
function isUnlocked() {
  try {
    const entry = JSON.parse(localStorage.getItem('medshare_unlocked') || 'null');
    return entry && Date.now() < entry.expiry;
  } catch { return false; }
}

function setUnlocked() {
  localStorage.setItem('medshare_unlocked', JSON.stringify({
    expiry: Date.now() + UNLOCK_DURATION_MS
  }));
}

async function showAppIfCached() {
  if (isUnlocked()) {
    pinCard.classList.add('hidden');
    appUI.classList.remove('hidden');
    await startAppUI();
  }
}

pinBtn.addEventListener('click', async () => {
  if (pinInput.value === SECRET_PIN) {
    setUnlocked();
    pinCard.classList.add('hidden');
    appUI.classList.remove('hidden');
    await startAppUI();
  } else {
    pinMsg.textContent = "Incorrect PIN";
    pinInput.value = "";
  }
});

/* Display example URL */
function showShortcutExample() {
  shortcutExample.textContent = makeShortcutUrl({
    action: 'log',
    pin: SECRET_PIN,
    time: '06:30',
    user: 'Bart',
    med: 'LamBri'
  });
}

let uiStarted = false;

async function startAppUI() {
  if (uiStarted) return;
  uiStarted = true;

  amManualBtn.addEventListener('click', async () => {
    await toggleSlot('amGiven');
    await refreshUI();
  });
  pmManualBtn.addEventListener('click', async () => {
    await toggleSlot('pmGiven');
    await refreshUI();
  });

  manualLogBtn.addEventListener('click', async () => {
    const user = manualUser.value || 'Bart';
    const med = manualMed.value || 'LamBri';
    const time = manualTime.value;

    const ref = todayDocRef();
    const snap = await getDoc(ref);

    let amGiven = false, pmGiven = false;
    if (snap.exists()) {
      const d = snap.data();
      amGiven = !!d.amGiven;
      pmGiven = !!d.pmGiven;
    }

    if (time === "06:30") amGiven = true;
    else pmGiven = true;

    await secureWrite(ref, {
      amGiven, pmGiven,
      count: (amGiven?1:0)+(pmGiven?1:0),
      lastUser: user,
      lastMed: med,
      lastTs: new Date().toISOString()
    });

    await refreshUI();
  });

  clearBtn.addEventListener('click', async () => {
    if (!confirm("Reset all?")) return;

    const col = await getDocs(collection(db, 'pillLog'));
    for (const d of col.docs) {
      await secureWrite(doc(db,'pillLog',d.id), {
        amGiven: false, pmGiven: false, count: 0,
        lastUser: "", lastMed: "", lastTs: ""
      });
    }
    await refreshUI();
  });

  showShortcutExample();
  await refreshUI();
}

/* Toggle AM/PM */
async function toggleSlot(slot) {
  const ref = todayDocRef();
  const snap = await getDoc(ref);

  let amGiven = false, pmGiven = false;
  if (snap.exists()) {
    amGiven = !!snap.data().amGiven;
    pmGiven = !!snap.data().pmGiven;
  }

  if (slot === "amGiven") amGiven = !amGiven;
  if (slot === "pmGiven") pmGiven = !pmGiven;

  await secureWrite(ref, {
    amGiven, pmGiven,
    count: (amGiven?1:0)+(pmGiven?1:0),
    lastUser: manualUser.value || 'Bart',
    lastMed: manualMed.value || 'LamBri',
    lastTs: new Date().toISOString()
  });
}

/* Refresh UI */
async function refreshUI() {
  const col = await getDocs(collection(db,'pillLog'));

  // last given
  let latest = null;
  col.forEach(d => {
    const data = d.data();
    if (data.lastTs && (!latest || data.lastTs > latest.lastTs)) {
      latest = { id: d.id, ...data };
    }
  });

  if (latest) {
    lastGiven.textContent =
      `${latest.lastMed} (${latest.lastUser}) on ${latest.id} at ${latest.lastTs.slice(11,16)}`;
  } else {
    lastGiven.textContent = "—";
  }

  // today buttons
  const todaySnap = await getDoc(todayDocRef());
  if (todaySnap.exists()) {
    const d = todaySnap.data();
    if (d.amGiven) amManualBtn.classList.add("active");
    else amManualBtn.classList.remove("active");

    if (d.pmGiven) pmManualBtn.classList.add("active");
    else pmManualBtn.classList.remove("active");
  }

  // week view
  const arr = [];
  col.forEach(doc => {
    arr.push({ id: doc.id, ...doc.data() });
  });

  arr.sort((a,b) => a.id.localeCompare(b.id));

  const last7 = arr.slice(-7);
  weekHistory.innerHTML = "";

  last7.forEach(d => {
    const c = d.count || 0;
    let cls = "circle";
    if (c === 1) cls += " half";
    if (c >= 2) cls += " full";

    weekHistory.innerHTML += `
      <div class="day">
        <div>${d.id}</div>
        <div class="circles">
          <div class="${cls}"></div>
        </div>
      </div>`;
  });
}

(async () => {
  if (await handleAutoLog()) return;
  await showAppIfCached();
})();
</script>
</body>
</html>
